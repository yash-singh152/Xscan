{% extends 'base.html' %}

{% block title %}Signal Dashboard | XScan{% endblock %}

{% block content %}
<div class="scanline"></div>

<div class="dashboard-wrapper" style="max-width: 1400px; margin: 0 auto;">

    <!-- Top Row: Hero Metrics -->
    <div class="dashboard-grid">

        <!-- Income Style Card (Total Scans) -->
        <div class="card glass-card" style="padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <span style="font-size: 0.75rem; color: var(--text-secondary); font-weight: 600;">Last Checked Domain:
                    {% if last_scan %}{{ last_scan.target_url }}{% else %}N/A{% endif %}</span>
                <span style="color: var(--text-muted);">...</span>
            </div>
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total Signals
                Processed</div>
            <div style="display: flex; align-items: baseline; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="font-size: 2.25rem; font-weight: 700;">{{ scans_count }}</div>
            </div>
            <div style="font-size: 0.75rem; color: var(--success); display: flex; align-items: center; gap: 0.25rem;">
                <span style="font-size: 0.6rem;">▲</span> 83% <span style="color: var(--text-muted);">vs previous
                    period</span>
            </div>
        </div>

        <!-- Net Income Style Card (Overall Health) -->
        <div class="card glass-card" style="padding: 1.5rem; position: relative; overflow: hidden;">
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem;">
                <span style="font-size: 0.75rem; color: var(--text-secondary); font-weight: 600;">System Health
                    Index</span>
                <div style="color: var(--text-muted); font-size: 0.75rem;">Last Result</div>
            </div>
            <div style="text-align: center; margin-bottom: 1rem;">
                <div style="font-size: 0.75rem; color: var(--text-secondary);">Security Rating Score</div>
                <div class="font-size-24 font-weight-700 
                    {% if system_status == 'SECURE' %}status-secure
                    {% elif system_status == 'VULNERABLE' %}status-vulnerable
                    {% else %}status-critical{% endif %}" style="font-size: 1.5rem; font-weight: 700;">
                    {{ system_status }}
                </div>
            </div>
            <!-- SVG Mini Chart Placeholder -->
            <div style="height: 60px; width: 100%;">
                <svg viewBox="0 0 400 60" preserveAspectRatio="none"
                    style="filter: drop-shadow(0 0 5px var(--accent-glow));">
                    <path d="M0,50 Q100,20 200,40 T400,10" fill="none" stroke="var(--accent)" stroke-width="2"
                        stroke-dasharray="5,5" />
                    <path d="M0,60 L0,50 Q100,20 200,40 T400,10 L400,60 Z" fill="url(#grad)" opacity="0.1" />
                    <defs>
                        <linearGradient id="grad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:var(--accent);stop-opacity:1" />
                            <stop offset="100%" style="stop-color:var(--accent);stop-opacity:0" />
                        </linearGradient>
                    </defs>
                </svg>
            </div>
        </div>

        <!-- Expenses Style Card (Threats) -->
        <div class="card glass-card" style="padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem;">
                <span style="font-size: 0.75rem; color: var(--text-secondary); font-weight: 600;">Threat Surface</span>
                <div style="color: var(--text-muted); font-size: 0.75rem;">Latest Findings</div>
            </div>
            <div style="text-align: center; margin-bottom: 1rem;">
                <div style="font-size: 0.75rem; color: var(--text-secondary);">Total Vulnerabilities Found</div>
                <div style="font-size: 1.5rem; font-weight: 700;">{{ threats_count }}</div>
            </div>
            <!-- SVG Mini Chart Placeholder -->
            <div style="height: 60px; width: 100%;">
                <svg viewBox="0 0 400 60" preserveAspectRatio="none">
                    <path d="M0,10 Q100,40 200,20 T400,50" fill="none" stroke="var(--danger)" stroke-width="2"
                        stroke-dasharray="5,5" />
                    <path d="M0,60 L0,10 Q100,40 200,20 T400,50 L400,60 Z" fill="rgba(239, 68, 68, 0.1)" />
                </svg>
            </div>
        </div>
    </div>

    <!-- Middle Row: Analytics -->
    <div class="dashboard-grid">

        <!-- P&L Style Metrics -->
        <div class="card glass-card" style="padding: 1.5rem; grid-row: span 2;">
            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 1.5rem; font-weight: 600;">
                Target Metrics: {% if last_scan %}{{ last_scan.target_url }}{% else %}N/A{% endif %}</div>
            <table style="width: 100%; font-size: 0.8125rem;">
                <tr style="color: var(--text-muted); border-bottom: 1px solid var(--border);">
                    <th style="text-align: left; padding: 0.5rem 0;">Metric Type</th>
                    <th style="text-align: right; padding: 0.5rem 0;">Count</th>
                    <th style="text-align: right; padding: 0.5rem 0;">Trend</th>
                </tr>
                <tr>
                    <td style="padding: 0.75rem 0;">Critical Risks</td>
                    <td style="text-align: right; font-weight: 600; color: var(--danger);">{{ critical_count }}</td>
                    <td style="text-align: right; color: var(--danger);">▲ 10%</td>
                </tr>
                <tr>
                    <td style="padding: 0.75rem 0;">High Risks</td>
                    <td style="text-align: right; font-weight: 600; color: var(--warning);">{{ high_count }}</td>
                    <td style="text-align: right; color: var(--success);">▼ 5%</td>
                </tr>
                <tr>
                    <td style="padding: 0.75rem 0;">Low Severity</td>
                    <td style="text-align: right; font-weight: 600; color: var(--info);">{{ low_count }}</td>
                    <td style="text-align: right; color: var(--text-muted);">--</td>
                </tr>
                <tr>
                    <td style="padding: 0.75rem 0; font-weight: 700; color: var(--accent);">Baseline_Security</td>
                    <td style="text-align: right; font-weight: 700; color: var(--accent);">{{ security_score }}%</td>
                    <td style="text-align: right; color: var(--success);">▲ 2.1%</td>
                </tr>
            </table>
        </div>

        <!-- Breakdown Charts (SVG Placeholders) -->
        <div class="card glass-card" style="padding: 1.5rem; text-align: center;">
            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 1.5rem; font-weight: 600;">
                Threats by Category</div>
            <div style="display: flex; justify-content: center; align-items: center; height: 180px;">
                <!-- Simple SVG Bubble/Pie Placeholder -->
                <svg width="180" height="180" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="var(--border)" stroke-width="10" />
                    <circle cx="50" cy="50" r="45" fill="none" stroke="var(--danger)" stroke-width="10"
                        stroke-dasharray="70 100" stroke-dashoffset="25" />
                    <circle cx="50" cy="50" r="45" fill="none" stroke="var(--warning)" stroke-width="10"
                        stroke-dasharray="40 100" stroke-dashoffset="-45" />
                    <text x="50" y="55" text-anchor="middle" font-family="var(--font-heading)" font-size="14"
                        fill="var(--text-primary)">{{ threats_count }}</text>
                </svg>
            </div>
            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; font-size: 0.7rem;">
                <span style="display: flex; align-items: center; gap: 0.25rem;">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--danger);"></div> Critical
                </span>
                <span style="display: flex; align-items: center; gap: 0.25rem;">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--warning);"></div> High
                </span>
            </div>
        </div>

        <div class="card glass-card" style="padding: 1.5rem; text-align: center;">
            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 1.5rem; font-weight: 600;">Scan
                Success Rate</div>
            <div style="display: flex; justify-content: center; align-items: center; height: 180px;">
                <svg width="180" height="180" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="35" fill="none" stroke="var(--success)" stroke-width="8"
                        stroke-dasharray="90 100" />
                    <circle cx="50" cy="50" r="20" fill="var(--success)" opacity="0.1" />
                    <text x="50" y="55" text-anchor="middle" font-size="12" fill="var(--success)"
                        font-weight="700">90%</text>
                </svg>
            </div>
            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 1rem;">Signals successfully resolved
            </div>
        </div>

        <!-- Overdue Style List (Active Vulnerabilities) -->
        <div class="card glass-card" style="padding: 1.5rem; grid-column: span 2;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span style="font-size: 0.75rem; color: var(--text-secondary); font-weight: 600;">Open Critical
                    Vulnerabilities</span>
            </div>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.8125rem;">
                <tr style="color: var(--text-muted); border-bottom: 1px solid var(--border); text-align: left;">
                    <th style="padding: 0.5rem;">Target URL</th>
                    <th style="padding: 0.5rem;">Vulnerability</th>
                    <th style="padding: 0.5rem; text-align: right;">Severity</th>
                </tr>
                {% for threat in recent_threats|slice:":4" %}
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 0.75rem 0.5rem;">{{ threat.scan.target_url }}</td>
                    <td style="padding: 0.75rem 0.5rem; font-weight: 600;">{{ threat.title }}</td>
                    <td style="padding: 0.75rem 0.5rem; text-align: right;">
                        <span
                            class="badge {% if threat.severity == 'Critical' %}severity-critical{% else %}severity-high{% endif %}">
                            {{ threat.severity }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>

    <!-- Bottom Row: Recent Activity -->
    <div class="card glass-card" style="padding: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="font-size: 1rem; font-weight: 600;">Signal Activity Logs</h3>
            <a href="{% url 'scan_list' %}" style="font-size: 0.75rem; color: var(--accent);">View Audit Trail</a>
        </div>
        <div style="overflow-x: auto;">
            <table style="width: 100%; text-align: left; border-collapse: collapse; font-size: 0.8125rem;">
                <thead>
                    <tr style="color: var(--text-muted); border-bottom: 1px solid var(--border);">
                        <th style="padding: 0.75rem;">Source</th>
                        <th style="padding: 0.75rem;">Type</th>
                        <th style="padding: 0.75rem;">Status</th>
                        <th style="padding: 0.75rem; text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scan in scans|slice:":4" %}
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 1rem 0.75rem; font-weight: 600;">{{ scan.target_url }}</td>
                        <td style="padding: 1rem 0.75rem;">{{ scan.scan_type }}</td>
                        <td style="padding: 1rem 0.75rem;">
                            <span style="display: inline-flex; align-items: center; gap: 0.4rem;">
                                <div class="width-6 height-6 border-radius-50 {% if scan.status|lower == 'completed' %}scan-status-completed{% elif scan.status|lower == 'running' %}scan-status-running{% else %}scan-status-failed{% endif %}"
                                    style="width: 6px; height: 6px; border-radius: 50%;"></div>
                                {{ scan.status|capfirst }}
                            </span>
                        </td>
                        <td style="padding: 1rem 0.75rem; text-align: right;">
                            <a href="{% url 'scan_detail' scan.id %}"
                                style="color: var(--accent); font-weight: 600;">Report</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}